"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("next/server"),n=require("@kinde/jwt-decoder");function t(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,n){if(!e)return;if("string"==typeof e)return r(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return r(e,n)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function o(e,n,t,r){return new(t||(t=Promise))((function(o,i){function u(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(u,c)}a((r=r.apply(e,n||[])).next())}))}function i(e,n){var t,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(u=0)),u;)try{if(t=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return u.label++,{value:c[1],done:!1};case 5:u.label++,r=c[1],c=[0];continue;case 7:c=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){u=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){u.label=c[1];break}if(6===c[0]&&u.label<o[1]){u.label=o[1],o=c;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(c);break}o[2]&&u.ops.pop(),u.trys.pop();continue}c=n.call(e,u)}catch(e){c=[6,e],r=0}finally{t=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}"function"==typeof SuppressedError&&SuppressedError;function u(e){if(null!=e)return(e=e.trim()).endsWith("/")&&(e=e.slice(0,-1)),e}var c=u(process.env.KINDE_SITE_URL),a=u(process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH)||u(process.env.KINDE_AUTH_API_PATH)||"/api/auth",l=u(process.env.KINDE_POST_LOGIN_REDIRECT_URL)||u(process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL),s=u(process.env.KINDE_POST_LOGOUT_REDIRECT_URL),f=u(process.env.KINDE_ISSUER_URL),d=process.env.KINDE_CLIENT_ID,p=process.env.KINDE_CLIENT_SECRET,v=process.env.KINDE_AUDIENCE,h=u(process.env.KINDE_COOKIE_DOMAIN),g=process.env.KINDE_SCOPE||"openid profile email offline",_={isDebugMode:"true"===process.env.KINDE_DEBUG_MODE,apiPath:a,initialState:{accessToken:null,idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganizations:[],getAccessToken:function(){return null},getBooleanFlag:function(){return null},getClaim:function(){return null},getFlag:function(){return null},getIdToken:function(){return null},getIntegerFlag:function(){return null},getOrganization:function(){return null},getPermission:function(){return null},getPermissions:function(){return[]},getStringFlag:function(){return null},getToken:function(){return null},getUser:function(){return null},getUserOrganizations:function(){return null},refreshData:function(){return null}},SESSION_PREFIX:"pkce-verifier",redirectURL:c,postLoginRedirectURL:l,issuerURL:f,clientID:d,clientSecret:p,postLogoutRedirectURL:s,audience:v?v.split(" "):"",cookieDomain:h,responseType:"code",codeChallengeMethod:"S256",redirectRoutes:{callback:"".concat(a,"/kinde_callback")},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"},clientOptions:{audience:v?v.split(" "):"",authDomain:f||"",clientId:d||"",clientSecret:p||"",logoutRedirectURL:s||"",redirectURL:"".concat(c,"/api/auth/kinde_callback"),frameworkVersion:"2.4.6",scope:g},grantType:"AUTHORIZATION_CODE"},R=function(e){var r,o,i=null!==(r=null==e?void 0:e.access_token)&&void 0!==r?r:e;if(!i)return!1;var u=n.jwtDecoder(i,n.TokenPart.header),c=n.jwtDecoder(i),a=!0;return _.audience&&(a=c.aud&&(o=c.aud).includes.apply(o,t(_.audience))),!!(c.iss==_.issuerURL&&"RS256"==u.alg&&c.exp>Math.floor(Date.now()/1e3)&&a)},y=function(e){return e&&"/"===e.charAt(e.length-1)?e.slice(0,-1):e};var I=function(t,r,u){return o(void 0,void 0,void 0,(function(){var o,c,a,l,s,f,d,p,v,h,g;return i(this,(function(i){switch(i.label){case 0:return o=t.nextUrl.pathname,c=null==r?void 0:r.isReturnToCurrentPage,a=(null==r?void 0:r.loginPage)||"/api/auth/login",l=["/_next","/favicon.ico"],void 0!==(null==r?void 0:r.publicPaths)&&Array.isArray(null==r?void 0:r.publicPaths)&&(l=r.publicPaths),s=c?"".concat(a,"?post_login_redirect_url=").concat(o):a,a==o||l.some((function(e){return o.startsWith(e)}))?[2]:(f=t.cookies.get("access_token"))?(d=n.jwtDecoder(null===(h=t.cookies.get("access_token"))||void 0===h?void 0:h.value),p=n.jwtDecoder(null===(g=t.cookies.get("id_token"))||void 0===g?void 0:g.value),(v=(null==r?void 0:r.isAuthorized)?r.isAuthorized({req:t,token:d}):R(f.value))&&u?[4,u({token:d,user:{family_name:p.family_name,given_name:p.given_name,email:p.email,id:p.sub,picture:p.picture}})]:[3,2]):[2,e.NextResponse.redirect(new URL(s,(null==r?void 0:r.redirectURLBase)||_.redirectURL))];case 1:return[2,i.sent()];case 2:return v?[2]:[2,e.NextResponse.redirect(new URL(s,(null==r?void 0:r.redirectURLBase)||_.redirectURL))]}}))}))};exports.authMiddleware=function(n){var t=y(n.nextUrl.href),r=y(_.postLogoutRedirectURL),o=n.cookies.get("kinde_token"),i=t===r,u=R(null==o?void 0:o.value);return u||i?u&&i?e.NextResponse.redirect(new URL(_.postLoginRedirectURL)):e.NextResponse.next():e.NextResponse.redirect(new URL(_.postLogoutRedirectURL,n.url))},exports.withAuth=function(){for(var e=this,n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];if(!n.length||n[0]instanceof Request)return I.apply(void 0,n);if("function"==typeof n[0]){var r=n[0],u=n[1];return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return o(e,void 0,void 0,(function(){var e=this;return i(this,(function(t){switch(t.label){case 0:return[4,I(n[0],u,(function(t){return o(e,[t],void 0,(function(e){var t=e.token,o=e.user;return i(this,(function(e){switch(e.label){case 0:return n[0].kindeAuth={token:t,user:o},[4,r.apply(void 0,n)];case 1:return[2,e.sent()]}}))}))}))];case 1:return[2,t.sent()]}}))}))}}var c=n[0];return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return o(e,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,I(n[0],c)];case 1:return[2,e.sent()]}}))}))}};
//# sourceMappingURL=index.js.map
